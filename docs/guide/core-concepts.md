# Core Concepts

## Build-Time vs Runtime

Nuxt Prepare scripts run **during the build process**, not at runtime. This happens when you execute commands like `nuxt dev`, `nuxt build`, or `nuxt prepare`.

```
nuxt dev/build → Prepare scripts run → Nuxt builds your app → App runs
```

This timing is crucial because:

- Scripts run **once per build**, not on every request
- You can perform expensive operations (API calls, data fetching) without impacting runtime performance
- Results are embedded into your application at build-time

## The Problem Nuxt Prepare Solves

Nuxt's configuration file (`nuxt.config.ts`) doesn't support async operations. This means you can't:

```ts
// ❌ This doesn't work in nuxt.config.ts
export default defineNuxtConfig({
  runtimeConfig: {
    apiUrl: await fetchApiUrl() // Error: top-level await
  }
})
```

Nuxt Prepare fills this gap by running async code before the configuration is finalized.

## How It Works

### 1. Script Execution

When Nuxt builds your app, prepare scripts are executed in order (or in parallel if configured). Each script returns a result that can modify your Nuxt configuration or pass data to your app.

### 2. Generated Files

The module generates TypeScript files in `.nuxt/module/nuxt-prepare/`:

**`.nuxt/module/nuxt-prepare.mjs`** – Contains exported state values:

```ts
// Generated by nuxt-prepare
export const todos = [
  { id: 1, title: 'Learn Nuxt Prepare' }
]
```

**`.nuxt/module/nuxt-prepare.d.ts`** – Provides full type safety:

```ts
// Generated by nuxt-prepare
export declare const todos: [{ id: number, title: string }]
export type Todos = typeof todos
```

### 3. Module Alias

The generated files are available via the `#nuxt-prepare` alias, which works in:

- **Nuxt app** – Components, composables, pages, layouts
- **Nitro server** – API routes, middleware, server utilities

```ts
// Works everywhere
import { todos } from '#nuxt-prepare'
```

## State Serialization

State values are JSON-serialized during code generation. This means:

- ✅ Objects, arrays, strings, numbers, booleans, null
- ❌ Functions, classes, symbols, undefined

```
// ✅ This works
state: {
  config: { api: 'https://api.example.com' },
  items: [1, 2, 3]
}

// ❌ This doesn't work
state: {
  handler: () => console.log('hello'), // Functions are lost
  data: undefined // Becomes null
}
```

## When to Use Each Option

Your prepare script can return three types of data:

| Option | Use Case | Availability |
|--------|----------|--------------|
| `state` | Pass build-time data to your app | Everywhere via `#nuxt-prepare` |
| `runtimeConfig` | Set runtime configuration dynamically | Everywhere via `useRuntimeConfig()` |
| `appConfig` | Set app configuration dynamically | Everywhere via `useAppConfig()` |

**Use `state`** when you want to prefetch data and make it available as importable constants.

**Use `runtimeConfig`** when you need to set environment-based or computed config values that should be accessible via Nuxt's runtime config.

**Use `appConfig`** when you need to set app-wide configuration that should be accessible via Nuxt's app config.
